<!DOCTYPE html>
<!DOCTYPE HTML>
<html>
<head>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
     <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<style>
		 html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 60%;
          left: 0%;
          width:100%;
          top:0%;
      }
      .controls {
        margin-top: 10px;
        border: 1px solid transparent;
        border-radius: 2px 0 0 2px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        height: 32px;
        outline: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }
      #pac-input {
        background-color: #fff;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        margin-left: 12px;
        padding: 0 11px 0 13px;
        text-overflow: ellipsis;
        width: 300px;
      }
      #pac-input:focus {
        border-color: #4d90fe;
      }
      .pac-container {
        font-family: Roboto;
      }
      #type-selector {
        color: #fff;
        background-color: #4d90fe;
        padding: 5px 11px 0px 11px;
      }
      #type-selector label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }
        .center-this {
			float: none;
			margin: 0 auto;
		}
        
	</style>
    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
</head>
<body> 
<header class = "w3-container w3-blue">
<h1 align = "center">rideHacks </h1>
    </header> 
<br>


   
   <br> 
    
   <div class="container">
       <br>
     
  <h2 align = "center">Your Events
      <!-- <button  type="button" class="btn btn-info btn-xs" data-toggle="modal" data-target="#myModal2">?</button>-->
</h2>
<!-- Modal -->
<div id="myModal2" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Confused?</h4>
      </div>
      <div class="modal-body">
        <p ><div align='left'>
          Select a row in your events to see more information on the map.
        
          </div>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
       <br> 
  <p>Click on an event below to see more information on map OR click on the map events.</p>            
  <table id = "tableEvents" class="table table-hover">
    <thead>
      <tr>
          <th>Event</th>
        <th>Location</th>
          <th>Dates</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>TribeHacks</td>
        <td>WM</td>
        <td>4/1/2016</td>
      </tr>
      <tr>
        <td>HackUMBC</td>
        <td>UMBC</td>
        <td>Ended</td>
      </tr> 
      <tr>
        <td>BitCamp</td>
        <td>The Evil Empire</td>
        <td>Never</td>
      </tr>
    </tbody>
  </table>
</div>
    

<div class = "w3-center">
    <nav class="w3-btn w3-blue">
  <ul class="nav navbar-nav">
    <li><a class = "w3-hover-blue" onclick = "showHackathons()"> Show All Events</a> </li>

</nav>
       <button  type="button" class="btn btn-info btn-xs" data-toggle="modal" data-target="#myModal">?</button>

<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Confused?</h4>
      </div>
      <div class="modal-body">
        <p ><div align='left'>1) Type your location into the textbox on top of the google map. <br>
           2) Select a red event pin to choose which Hackathon you want to find transport information about. <br>
           3) Scroll below the map and choose whether you are driving or looking for a ride.  <br>
           4) Add event!
          <br><br>
           <div align = 'right' style = 'margin-right: 40px' > <img src = 'ButterflyKisses.png' style="width:200px; height:120px"></div>
          </div>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
       
       <!--   <nav class="w3-btn w3-blue">
  <ul class="nav navbar-nav">
    <li><a class = "w3-hover-blue" onclick = "showYourHackathons()"> Show Your Events</a> </li>

</nav>-->
</div>
      <input id="pac-input" class="controls" type="text" placeholder="Enter your location">
    <br>
    <div  id="map"></div>
    
    <div class= "w3-center"> 
      
        <div class = "w3-container w3-blue ">
        <h3>Are you <button class="w3-btn w3-border w3-border-white w3-blue w3-round w3-hover-white" id = 'Driving' onclick = "selectButton('Driving')">   Offering to Drive    </button> or 
          
  <button class="w3-btn w3-border w3-border-white w3-blue w3-round w3-hover-white" id = 'l4' onclick = "selectButton('l4')">Looking for a ride</button></h3>
    </div>

        
    </div>
    <div class="container">
    
    </div>
          
    <div class = "w3-center">
          <div id = 'er' style = "visibility: hidden" class="alert" role="alert">
  <strong>Error!</strong> Change a few things up and try submitting again.
</div>
        <button class= "w3-btn w3-blue w3-rounder w3-round w3-hover-white w3-center" id = "adder" onClick = "verifyPin()">Add Event </button>
       
    </div>
   <br><br>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
     <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPuhAA-CpEQ6g9BuOJxg1tfe5PF9BjmXc&libraries=places&callback=initMap"
        async defer></script>
    <script>
      // This example requires the Places library. Include the libraries=places
      // parameter when you first load the API. For example:
      // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">
        var ref;
        var geocoder;
        var map;
        var hackathonLoc;
        var uid;
        var hackathonLocEvent;  
        var curloc;
        var hackDate;
        var pos;
        var mIndex = 0;
        var markers = new Array();
        var userMarkers = new Array();
        var selectedBTN;
        var markerToAdd;
        var markerArray = new Array();
        var contentArray = new Array();
        var directionsService;
        var directionsDisplay;
        var hasUserAddress;
        var userIsDriving;
        var email;
        var userAddress;
        var selectedHackathon = false;
        function verifyPin() {
            var erStr = "";
            if(!(selectedBTN == "l4" || selectedBTN == "Driving")) 
            {
                erStr += "Select if you are driving or looking for a driver<br>";
            }
            if(document.getElementById("pac-input").value == "") {
                erStr +="Please add your location<br>";
            }
            if(hackathonLoc == "" || hackathonLoc == undefined) {
                erStr += "Please select the desired hackathon from the map";
            }
            if(erStr != "") {
                document.getElementById("er").style.visibility = "visible";
                document.getElementById("er").class += "alert-danger"
                document.getElementById("er").innerHTML = "<strong>Error!</strong><br>" + erStr;
            }   
    var dont = false;
    if(erStr == "") {
        document.getElementById("er").style.visibility = "hidden";
        ref.once("value", function(snap) {
            var obj = snap.val();
           
            for(var i in obj["Users"]) {
             
                if(obj["Users"][i]["UserID"] == uid) {
                    name = obj["Users"][i]["Name"];
                    email = obj["Users"][i]["EmailAddress"];
                
                    if(addDriveLocation(hackathonLocEvent, document.getElementById("pac-input").value, obj["Users"][i]["Name"],obj["Users"][i]["EmailAddress"], document.getElementById(selectedBTN).innerHTML.trim(), hackDate, pos) == false) 
                        {
                            
                            dont = true;
                        }
                    else{  if(mrk != null) {mrk.setMap(null)};}
                    break;
                }
            }
        });
         
        if(!dont){
          
        document.getElementById("er").style.visibility = "visible";
        document.getElementById("er").class += "alert alert-success"
        document.getElementById("er").innerHTML = "<strong>Event added! </strong>";
            console.log(hackathonLocEvent);
            setTimeout(            displayMapOfEvent(hackathonLocEvent), 1000);
         
        }
        //clearMarkerArray();
          // displayMapOfEvent(hackathonLocEvent);
    }
}
function selectButton(btn) {
    if(selectedBTN == btn) {
        selectedBTN = "";
        document.getElementById(btn).className =  "w3-btn w3-border w3-border-white w3-blue w3-round w3-hover-white";
    }
    else if(selectedBTN != "")   {
            if(selectedBTN == 'l4') {
                selectedBTN = btn;
                document.getElementById('l4').className =  "w3-btn w3-border w3-border-white w3-blue w3-round w3-hover-white";
                document.getElementById(btn).className =  'w3-btn w3-white w3-round w3-hover-white';
            }
            else {
                selectedBTN = btn;
                document.getElementById('Driving').className =  "w3-btn w3-border w3-border-white w3-blue w3-round w3-hover-white";
                document.getElementById(btn).className =  'w3-btn w3-white w3-round w3-hover-white';
            }
    }
    else {
        selectedBTN = btn;
        document.getElementById(btn).className = 'w3-btn w3-white w3-round w3-hover-white';
    }

}
        var mrk;
function initMap() {
    ref = new Firebase("https://hackathondrive.firebaseio.com/")
    //uid = ref.getAuth().uid;
    uid = "0ba45088-159a-4de0-a65f-eea581bda61f";      
    geocoder = new google.maps.Geocoder();
    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 39.887, lng: -96.437},
        zoom: 4,
        scrollwheel: false,
        streetViewControl: false
    });
    var input = /** @type {!HTMLInputElement} */(document.getElementById('pac-input'));
    var types = document.getElementById('type-selector');
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(types);
    var autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', map);
    document.getElementById("pac-input").style.visibility = "visible";           
    //autocomplete.addListener('place_changed', function() {infowindow.close();});
    //var infowindow = new google.maps.InfoWindow();
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(types);  
    autocomplete.bindTo('bounds', map);
    var pinColor = "00FF00";
    var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
        new google.maps.Size(71, 71),
        new google.maps.Point(0,0),
        new google.maps.Point(17, 34));
        var marker = new google.maps.Marker({
            map: map,
            anchorPoint: new google.maps.Point(0, -29),
            icon: pinImage
            });
        autocomplete.addListener('place_changed', function() {
        marker.setVisible(false);
        var place = autocomplete.getPlace();
          
          marker.setPosition(place.geometry.location);
          pos = place.geometry.location;
          marker.setVisible(true);
    
          var address = '';
          if (place.address_components) {
            address = [
              (place.address_components[0] && place.address_components[0].short_name || ''),
              (place.address_components[1] && place.address_components[1].short_name || ''),
              (place.address_components[2] && place.address_components[2].short_name || '')
            ].join(' ');
          }
                     //infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
          //infowindow.open(map, this); 
            });
         
          markerToAdd = marker;
          directionsService = new google.maps.DirectionsService;
          directionsDisplay = new google.maps.DirectionsRenderer({
               suppressMarkers: true
          });
          directionsDisplay.setMap(map);
}     
        function addHackathonMarker(event, address, lat, lng, date) {

                var marker = new google.maps.Marker({position: {lat: lat, lng: lng}, map: map });
                markers[mIndex] = marker;
                mIndex++;

               var infowindow =  new google.maps.InfoWindow({ content: "TEST"});

               

       
            
            marker.addListener('click', function(){ hackathonLocEvent = event; hackDate = date; displayMapOfEvent(event);for(var i = 0; i < mIndex;i++) {
                markers[i].setMap(null);
                }
            mIndex = 0; markers = new Array();
            });
            marker.addListener('mouseover', function(){
                var stringContent = '<div class = "w3-container w3-padding w3-center">' +
                                '<h2>' + event + '</h2>' +
                                '<p>' + address + '</p>' + '<p>' + date.month + ' ' + date.day + ', ' + date.year + '</p>' +
                                '</div>'; 
 				infowindow.setContent(stringContent);
        			
        			infowindow.open(map, this);
               
            });
            marker.addListener('mouseout', function(){
               
                infowindow.close();
            });
            
            //hackathonLoc.addListener('click', function(){});
            
                 
        }                       
        function addDriveLocation(event, address, name, email, desc, date,posit)
        {

             ref.once("value", function(snapshot) {

                 var obj = snapshot.val();

            //add driver/l4 to individual event
                for(var i in obj["Events"]) {      
                    for(var k in obj["Events"][i])
                        {
                                        
                            if(obj["Events"][i][k]["Email"] == email && obj["Events"][i]["Event"] == event) {
                              
                                document.getElementById("er").style.visibility = "visible";
                                document.getElementById("er").class += "alert alert-success"
                                document.getElementById("er").innerHTML = "<strong>You are already listed here! </strong>";
                                return false;
                            }
                        }
                if(obj["Events"][i]["Event"] == event) {
                    
                    ref.child("Events").child(i).push({Day: date.day, Month: date.month, Year: date.year, Address: address, Driving: desc, Email: email, Name: name, lat: posit.lat(), lng: posit.lng()});
                }
            }
            //add driver/l4 event to individual list
            for(var i in obj["Users"]) {
                if(obj["Users"][i]["EmailAddress"] == email) {
                    ref.child("Users").child(i).child("Events").push({Day: date.day, Month: date.month, Year: date.year, lat: posit.lat(), lng: posit.lng(), Address: address, Driving: desc, Event: event});
                }
            }
         },function (errorObject) {console.log("The read failed: " + errorObject.code);});  
            return true;
        }
          
      ref = new Firebase("https://hackathondrive.firebaseio.com/");
        
      //function generateTable(email) {
        var email = "EmailAddress";
        var name;
       
        ref.once("value", function(snap) {
                var obj = snap.val();
                for(var i in obj["Users"]) {
                    if(obj["Users"][i]["UserID"] == uid) {
                        name = obj["Users"][i]["Name"];
                        email = obj["Users"][i]["EmailAddress"];
                        var table = document.getElementById("tableEvents");
        
          var tablestr = "<thead><tr><th>Event</th><th>Location</th><th>Dates</th></tr></thead><tbody>";
              ref.once("value", function(snapshot) {
                

               
            var obj = snapshot.val();

            for(var i in obj["Users"]) {   
                if(obj["Users"][i]["EmailAddress"] == email) {
                    for(var j in obj["Users"][i]["Events"])
                        {
                            var address2;
                            var address = obj["Users"][i]["Events"][j]["Address"];
                            var Event = obj["Users"][i]["Events"][j]["Event"];
                            var year = obj["Users"][i]["Events"][j]["Year"];
                            var day = obj["Users"][i]["Events"][j]["Day"];
                            var month = obj["Users"][i]["Events"][j]["Month"];
                            var desc = obj["Users"][i]["Events"][j]["Driving"]
                            
                            for(var z in obj["Events"])
                                {
                                    if(obj["Events"][z]["Event"] == Event)
                                        {
                                            address2 = obj["Events"][z]["Address"];
                                        }
                                }
                            
                            
                            tablestr += "<tr onclick = 'if(map != undefined){map.setCenter({lat: 39.887, lng: -96.437}); map.setZoom(4);                 }if(userAddress != null){ userAddress.setMap(null);} if(hackathonLoc != null){hackathonLoc.setMap(null);} for(var i = 0; i < markerArray.length;i++) {  markerArray[i].setMap(null); } markerArray = new Array(); for(var i = 0; i < mIndex;i++) {  markers[i].setMap(null); } mIndex = 0; markers = new Array();displayMapOfEvent(" + '"' +Event +'"'+ ")'><td>" + Event + "<br>" + desc  +"</td><td>" + address2 + "</td><td>" + month + " " + day + ", " + year +"</td></tr>"                     
                           
                        }
                }
             
            }
                  
                  tablestr += "</tbody>"
                  table.innerHTML = tablestr;
                  
         },function (errorObject) {console.log("The read failed: " + errorObject.code);}); 
                        
                    }
                }
            });
       
          function clearMarkerArray() {
             try {
              if(userAddress != null) { userAddress.setMap(null);}
                 
              for(var i = 0; i < markerArray.length;i++) {
                  markerArray[i].setMap(null);
              }
                markerArray = new Array();
                 for(var i = 0; i < markers.length;i++) {
                  markers[i].setMap(null);
              }
                 markers = new Array();
                 mIndex = 0;
             }
              catch(e) {console.log(e.message);}
          }
         showHackathons();
         
         //Take in an event name to put all of its members markers and its own marker on map
            
            
        
            
           function displayMapOfEvent(eventName) {
                //var uid = ref.getAuth().uid;
                var uid = "0ba45088-159a-4de0-a65f-eea581bda61f";
                hasUserAddress = false;
                ref.once("value", function(snap) {
                    var obj = snap.val();
                    for(var i in obj["Users"]) {
                        if(obj["Users"][i]["UserID"] == uid) {
                            email = obj["Users"][i]["EmailAddress"];
                            
                            for(var j in obj["Users"][i]["Events"]) {
                                if(obj["Users"][i]["Events"][j]["Event"] == eventName) {
                                    var latLng = new google.maps.LatLng(obj["Users"][i]["Events"][j]["lat"], obj["Users"][i]["Events"][j]["lng"]);
                                    
                                    var userMarker = new google.maps.Marker({
                                        map: map,
                                        position: latLng,
                                        title: eventName,
                                        icon: 'Google_Maps_Markers/orange_MarkerY.png'
                                    });
                                    
                                    userAddress = userMarker;
                                    hasUserAddress = true;
                                    if(obj["Users"][i]["Events"][j]["Driving"] == "Offering to Drive") {
                                        userIsDriving = true;
                                    }  else {
                                        userIsDriving = false;
                                    }
                                    
                                    var userContentString = '<div class = "w3-container w3-padding w3-center">' +
                                        '<p>' + 'You' + '</p>' +
                                        '<p>' + obj["Users"][i]["Events"][j]["Address"] +'</p>' +
                                        '</div>';
                                    var info = new google.maps.InfoWindow();
                                    userMarker.addListener('mouseover', function() {
                                        info.setContent(userContentString);
                                        info.open(map, this);
                                    });
                                    userMarker.addListener('mouseout', function() {
                                        info.close(map, this);
                                    });
                                }
                            }
                        }
                    }
                    
                    var info1 = new google.maps.InfoWindow();
                    
                    var obj = snap.val();
                    
                    for(var i in obj["Events"]) {
                        if(obj["Events"][i]["Event"] == eventName) {
                            var latLng = new google.maps.LatLng(obj["Events"][i]["Lat"], obj["Events"][i]["Lng"]);
                            var marker = new google.maps.Marker({
                                map: map,
                                position: latLng,
                                title: eventName,
                                icon: 'Google_Maps_Markers/blue_MarkerH.png'
                            });
                            
                            hackathonLoc = marker;
                            var contentString = '<div class = "w3-container w3-padding w3-center">' +
                                '<h2>' + obj["Events"][i]["Event"] + '</h2>' +
                                '<p>' + obj["Events"][i]["Address"] + '</p>' + '<p>' + obj["Events"][i]["Month"] + ' ' + obj["Events"][i]["Day"] + ', ' + obj["Events"][i]["Year"] + '</p>' +
                                '</div>';
                            var info = new google.maps.InfoWindow();
                            marker.addListener('mouseover', function() {
                                info.setContent(contentString);
                                info.open(map, this);
                            });
                            marker.addListener('mouseout', function() {
                                info.close(map, this);
                            });
                            
                            //making a route from userAddress to hackathonLoc
                            if(hasUserAddress) {
                                directionsService.route({
                                    origin: userAddress.getPosition(),
                                    destination: hackathonLoc.getPosition(),
                                    travelMode: google.maps.TravelMode.DRIVING
                                }, function(response, status) {
                                    if (status === google.maps.DirectionsStatus.OK) {
                                        directionsDisplay.setDirections(response);
                                    } else {
                                        window.alert('Directions request failed due to ' + status);
                                    }
                                });
                            } else {
                                directionsDisplay.setDirections({routes: []});
                            }
                            if(!userIsDriving) {
                                directionsDisplay.setOptions({
                                    polylineOptions: {
                                        visible: false
                                    }
                                });
                            } else {
                                directionsDisplay.setOptions({
                                    polylineOptions: {
                                        visible: true
                                    }
                                });
                            }
                            
                            var x = 0;
                            for(var j in obj["Events"][i]) {
                                var address = obj["Events"][i][j]["Address"];
                                if(address != null && obj["Events"][i][j]["Email"] != email) {
                                    var latLng1 = new google.maps.LatLng(obj["Events"][i][j]["lat"], obj["Events"][i][j]["lng"]);
                                    
                                    var image;
                                    if(obj["Events"][i][j]["Driving"] == "Offering to Drive") {
                                        image = 'Google_Maps_Markers/red_MarkerD.png';
                                    } else {
                                        image = 'Google_Maps_Markers/yellow_MarkerL.png';
                                    }
                                    
                                    var marker1 = new google.maps.Marker({
                                        map: map,
                                        position: latLng1,
                                        title: obj["Events"][i][j]["Name"],
                                        icon: image
                                    });
                                    
                                    markerArray[x] = marker1;
                                     
                                    contentArray[x] = '<div class = "w3-container w3-padding w3-center">' +
                                        '<p>' + obj["Events"][i][j]["Name"] + '</p>' +
                                        '<p>' + obj["Events"][i][j]["Email"] + '</p>' +
                                        '<p>' + obj["Events"][i][j]["Address"] + '</p>' +
                                        '</div>';
                                    
                                    marker1.addListener('mouseover', function() {
                                        var notFound = true;
                                        for(var k = 0; k<1000 && notFound; k++) {
                                            if(markerArray[k] == this) {
                                                info1.setContent(contentArray[k]);
                                                notFound = false;
                                            }
                                        }
                                        info1.open(map,this);
                                    });
                                    marker1.addListener('mouseout', function() {
                                        info1.close(map,this);
                                    });
                                    x++;
                               
                                }
                            }
                        }
                    }
                    console.log(email);
                });
                
            }
        
       
        
            //return a latLng for address
            function codeAddress(address) {
                var geocoder = new google.maps.Geocoder();
                geocoder.geocode( { 'address': address}, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        return results[0].geometry.location;
                       
                    } else {
                        alert("Geocode was not successful for the following reason: " + status);
                    }
                });
            }
            
        
    </script>
</body> 
</html> 
